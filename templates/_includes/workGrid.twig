{% set work = craft.entries.section('work') %}
{% set workEntries = work.all() ?? [] %}
{% set navStyle = "icon" %} {# "icon" or "text" #}

{% if workEntries|length %}

  {% set workIDs = work.collect().pluck('id') %}

  <section
    x-cloak
    x-data="{
      showSlideover: false,
      selected: null,
      workIDs: {{ workIDs|json_encode|raw }},

      setSlideover: function (id) {
        this.selected = id;
        this.showSlideover = true;
      },

      top: function () {
        this.$refs['panel-content'].scrollTo({ top: 0, behavior: 'instant' });
      },

      prev: function () {
        if (this.hasPrev()) {
          this.selected = this.workIDs[this.index() - 1];
          this.top();
        }
      },

      next: function () {
        if (this.hasNext()) {
          this.selected = this.workIDs[this.index() + 1];
          this.top();
        }
      },

      hasPrev: function () {
        return this.workIDs.indexOf(this.selected) > 0;
      },

      hasNext: function () {
        return this.workIDs.indexOf(this.selected) < this.workIDs.length - 1;
      },

      index: function () {
        return this.workIDs.indexOf(this.selected);
      },
    }"
  >
    <h2 class="sr-only">Recent work</h2>

    {# Work card grid #}
    <div class="grid grid-cols-12 gap-y-24 lg:gap-x-16">
      {% for entry in workEntries %}

        {% set image = entry.cardImage.one() ?? null %}
        {% set cls = "" %}

        {# Vertical stacking #}
        {% if ((loop.index0 % 6) + 1 == 2)
          or ((loop.index0 % 6) + 1 == 5)
          or ((loop.index0 % 6) + 1 == 6)
        %}
          {% set cls = "ml-auto lg:ml-0" %}
        {% endif %}

        {# Three to a row with blanks #}
        {% if ((loop.index0 % 10) + 1) == 3
          or ((loop.index0 % 12) + 1) == 9
        %}
          <div class="hidden xl:block xl:col-span-4">{# blank grid space #}</div>
        {% endif %}

        {# Three to a row with blanks #}
        {% if ((loop.index0 % 12) + 1) == 3
          or ((loop.index0 % 12) + 1) == 6
          or ((loop.index0 % 12) + 1) == 9
          or ((loop.index0 % 12) + 1) == 13
        %}
          <div class="hidden xl:block xl:col-span-4">{# blank grid space #}</div>
        {% endif %}

        <div class="relative col-span-full space-y-5 w-full max-w-[480px] lg:max-w-none lg:col-span-6 xl:col-span-4 {{ cls }}">
          <h2 class="heading3-mono">{{ entry.title }}</h2>

          {% if image %}
            <div class="aspect-[480/288] shadow-sm">
              {% include "_includes/picture" with {
                disableAlt: true,
                image: image,
                mode: "crop",
                classes: "object-cover w-full h-full rounded-sm",
                ratio: [480, 288],
                pictureSets: [
                  { "467": [560, null] },
                  { "default": [414, null] },
                ],
              } only %}
            </div>
          {% endif %}

          {% include "_includes/workCardMeta" with {
            type: entry.workType,
            year: entry.year,
            agency: entry.agency,
          } %}

          <a
            @click.prevent="setSlideover({{ entry.id }})"
            @keydown.space.prevent="setSlideover({{ entry.id }})"
            href="{{ url(entry.uri) }}"
            class="box-link before:focus-visible:outline before:focus-visible:outline-2 before:focus-visible:outline-offset-2 before:focus-visible:outline-blue-700"
            aria-label="{{ 'View details, opens dialog'|t }}"
          ></a>
        </div>

      {% endfor %}
    </div>

    {# Slideover #}
    <div
      x-dialog
      x-model="showSlideover"
      style="display: none"
      class="fixed inset-0 z-10"
    >
      {# Backdrop overlay #}
      <div
        x-dialog:overlay
        x-transition.opacity.duration.600ms
        class="fixed inset-0 bg-[#dfdfdf]/65 backdrop-blur-lg"
      ></div>

      {# Panel background (white fill) #}
      <div
        class="fixed inset-y-0 right-0 bg-white w-[var(--panel-w)] 3xl:w-[var(--3xl-panel-w)]"
        x-show="showSlideover"
        x-transition:enter="transition duration-500"
        x-transition:enter-start="translate-x-8 opacity-0"
        x-transition:enter-end="translate-x-0 opacity-100"
        x-transition:leave="transition duration-500"
        x-transition:leave-start="translate-x-0 opacity-100"
        x-transition:leave-end="translate-x-8 opacity-0"
      ></div>

      {# Panel #}
      <div
        x-dialog:panel
        class="fixed inset-y-0 right-0 w-[var(--panel-w)] 3xl:w-[var(--3xl-panel-w)]"
      >
        <div
          x-ref="panel-content"
          x-show="showSlideover"
          x-transition.opacity.duration.500ms
          class="absolute inset-0 overflow-auto -ml-[var(--panel-away-w)] 3xl:-ml-[calc(100vw-var(--3xl-panel-w))]"
        >
          <div class="container">

            {# Nav and close buttons #}
            <div class="sticky top-0 inset-x-0 pointer-events-none pt-8 md:pt-[52px] 2xl:pt-[60px]">
              <div class="grid grid-cols-12 gap-x-16">
                <div class="col-span-9 col-start-3">
                  <div class="base-mono flex items-center justify-between">

                    {# Close #}
                    {% if navStyle == "icon" %}

                      <button
                        type="button"
                        @click="$dialog.close()"
                        @keydown.escape.window="$dialog.close()"
                        class="pointer-events-auto transition hover:rotate-90"
                      >
                        <span>{{ svg('@webroot/dist/images/icon--close.svg', true, true)|attr({ class: 'w-[44px]' }) }}</span>
                      </button>

                    {% else %}

                      <button
                        type="button"
                        @click="$dialog.close()"
                        @keydown.escape.window="$dialog.close()"
                        class="pointer-events-auto group"
                      >
                        <span>[Esc] <span class="group-hover:underline">Close</span></span>
                      </button>

                    {% endif %}

                    {# Nav #}
                    <div class="flex items-center justify-end gap-x-2">

                      {# Prev #}
                      {% if navStyle == "icon" %}

                        <button
                          class="pointer-events-auto"
                          :class="{ 'pointer-events-none text-gray-300': !hasPrev() }"
                          :tabindex="hasPrev() ? 0 : -1"
                          aria-label="Previous project"
                          @click="prev()"
                          @keydown.left.window="showSlideover && prev()"
                        >
                          <span>{{ svg('@webroot/dist/images/icon--arrow-right-circ.svg', true, true)|attr({ class: 'w-[44px] rotate-180' }) }}</span>
                        </button>

                      {% else %}

                        <button
                          class="pointer-events-auto group"
                          :class="{ 'pointer-events-none text-gray-100': !hasPrev() }"
                          :tabindex="hasPrev() ? 0 : -1"
                          aria-label="Previous project"
                          @click="prev()"
                          @keydown.left.window="showSlideover && prev()"
                          >
                          <span>[&#8592;] <span class="group-hover:underline">Previous</span></span>
                        </button>

                        <span class="text-gray-100"> / </span>

                      {% endif %}

                      {# Next #}
                      {% if navStyle == "icon" %}

                        <button
                          class="pointer-events-auto"
                          :class="{ 'pointer-events-none text-gray-100': !hasNext() }"
                          :tabindex="hasNext() ? 0 : -1"
                          aria-label="Next project"
                          @click="next()"
                          @keydown.right.window="showSlideover && next()"
                        >
                          <span>{{ svg('@webroot/dist/images/icon--arrow-right-circ.svg', true, true)|attr({ class: 'w-[44px]' }) }}</span>
                        </button>

                      {% else %}

                        <button
                          class="pointer-events-auto group"
                          :class="{ 'pointer-events-none text-gray-400': !hasNext() }"
                          :tabindex="hasNext() ? 0 : -1"
                          aria-label="Next project"
                          @click="next()"
                          @keydown.right.window="showSlideover && next()"
                        >
                          <span><span class="group-hover:underline">Next</span> [&#8594;] </span>
                        </button>

                      {% endif %}

                    </div>
                  </div>
                </div>
              </div>
            </div>

            {# Articles #}
            {% for entry in workEntries %}
              {% include "_includes/workArticle" with {
                entry: entry,
              } only %}
            {% endfor %}

          </div>
        </div>
      </div> {# /Panel #}

      {# Click away region #}
      <div
        @click="$dialog.close()"
        class="cursor-w-resize fixed left-0 inset-y-0 w-[var(--panel-away-w)] 3xl:w-[var(--3xl-panel-away-w)]"
      ></div>

    </div> {# /Slideover #}

  </section>

{% endif %}

